function process_appointment(a,e,o,r,t,i){var l=new Date;l=new Date(l.getTime()+6e4*l.getTimezoneOffset());var n=a[e].med_id,s=a[e].pat_id,c=(a[e].date.getMonth()+1).toString(),u=a[e].date.getDate().toString();c.length<2&&(c="0"+c),u.length<2&&(u="0"+u);var f=new Date(a[e].date.getFullYear()+"-"+c+"-"+u+"T"+a[e].start_time),$=new Date(a[e].date.getFullYear()+"-"+c+"-"+u+"T"+a[e].end_time),v=a[e].timezone.split(":"),d=36e5*parseInt(v[0]),p=6e4*parseInt(v[1]),h=1e3*parseInt(v[2]);"-"==v[0].charAt(0)&&(p*=-1,h*=-1);var m=d+p+h;f=new Date(f.getTime()+6e4*l.getTimezoneOffset()-m),$=new Date($.getTime()+6e4*l.getTimezoneOffset()-m),o.query("SELECT * FROM doctors WHERE id="+n,function(n,c){o.query("SELECT * FROM usuarios WHERE Identif="+s,function(n,s){for(var u=!0,v=0;v<t.length;v++)t[v]==c[0].id&&(u=!1);for(var v=0;v<r.length;v++)r[v]==s[0].Identif&&(u=!1);var d=!1;if(i.indexOf(c[0].id)>=0&&(d=!0),l>f&&$>l&&1!=c[0].in_consultation&&!d&&u){var p=-1,h=!1;if(null!=a[e].specific_time){var m=a[e].specific_time.split(":"),b=60*parseInt(m[0])+parseInt(m[1])+l.getTimezoneOffset(),g=60*l.getHours()+l.getMinutes();p=g-b,h=!0}if(!h||p>=0&&5>=p)if(t.push(c[0].id),r.push(s[0].Identif),0==a[e].video){proc.exec('C:\\xampp\\php\\php "C:\\xampp\\htdocs\\start_telemed_phonecall.php" '+s[0].Identif+" "+c[0].id+" "+s[0].Name+"_"+s[0].Surname+" "+c[0].Name+"_"+c[0].Surname+" "+s[0].telefono+" "+c[0].phone);var V=60*l.getHours()+l.getMinutes()-l.getTimezoneOffset(),w=V%60,G=V/60;o.query("UPDATE appointments SET processed=1, time_called='"+G+":"+w+":00' WHERE id="+a[e].id,function(){a.length>e+1?process_appointment(a,e+1,o,r,t,i):o.release()})}else proc.exec('C:\\xampp\\php\\php "C:\\xampp\\htdocs\\start_telemed_videocall.php" '+s[0].Identif+" "+c[0].id+" "+s[0].Name+"_"+s[0].Surname+" "+c[0].Name+"_"+c[0].Surname+" "+s[0].telefono+" "+c[0].phone),client.messages.create({body:"Your video consultation with Doctor "+c[0].Name+"_"+c[0].Surname+" is about to start. Please login to Health2Me to connect to your doctor.",to:"+"+s[0].telefono,from:"+19034018888"},function(){}),o.query("UPDATE usuarios SET current_calling_doctor="+c[0].id+" WHERE Identif="+s[0].Identif,function(){var c=60*l.getHours()+l.getMinutes()-l.getTimezoneOffset(),u=c%60,f=c/60;o.query("UPDATE appointments SET processed=1, time_called='"+f+":"+u+":00' WHERE id="+a[e].id,function(){a.length>e+1?process_appointment(a,e+1,o,r,t,i):o.release()})})}else a.length>e+1?process_appointment(a,e+1,o,r,t,i):o.release()})})}var mysql=require("mysql"),proc=require("child_process");require("C:\\Users\\Administrator\\AppData\\Roaming\\npm\\node_modules\\twilio");var host=location.hostname,pool=mysql.createPool({host:host,user:"monimed",password:"ardiLLA98",database:"monimed"});exports.pool=pool;var accountSid="AC109c7554cf28cdfe596e4811c03495bd",authToken="26b187fb3258d199a6d6edeb7256ecc1",client=require("C:\\Users\\Administrator\\AppData\\Roaming\\npm\\node_modules\\twilio")(accountSid,authToken);setInterval(function(){pool.getConnection(function(a,e){var o=new Date,r=o.getFullYear()+"-";o.getMonth()+1<10&&(r+="0"),r+=(o.getMonth()+1).toString()+"-",o.getDate()<10&&(r+="0"),r+=o.getDate().toString(),e.query("SELECT * FROM appointments WHERE date>='"+r+"' AND processed=0 ORDER BY date, start_time, id",function(a,o){if(o.length>0){var r=new Array,t=new Array,i=new Array;client.conferences.list({status:"in-progress"},function(a,l){l.conferences.forEach(function(a){var e=a.friendlyName,o=parseInt(e.split("_")[0]);i.indexOf(o)<0&&i.push(o)}),process_appointment(o,0,e,r,t,i)})}else e.release()})})},6e4);