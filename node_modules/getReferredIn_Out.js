var ReferQuery = function(req, res, pool) {

    var doctor = this.req.body['Dcotor'];
    var type = this.req.body['TypeEntry'];
    var num_reports = this.req.body['NReports'];
    var days_explore = this.req.body['days'];
    var group = this.req.body['Group'];
    
    this.pool.getConnection(function(err,connection)
    {
        if (err) 
        {
            connection.release();
            this.res.json({"code" : 100, "status" : "Error in connection database"});
            return;
        } 

        //Referred In
        if(type == 'in') {
            if(group == 0) {
                var query_str = "SELECT RES.*, RS.stage, RS.datevisit, D.Name AS DocName, D.Surname AS DocSurname, D.Role AS DocRole, U.Name AS PatName, U.Surname AS PatSurname, MI.count AS NewMesCount, MI.fecha AS NewMesFecha, MI2.count AS MesCount" +
    "FROM(SELECT * FROM doctorslinkdoctors WHERE IdMED2 = ? ORDER BY Fecha DESC LIMIT 10) RES" +
    
     "LEFT JOIN" +

     "referral_stage RS ON RS.referral_id = RES.id" +

     "LEFT JOIN" +

     "doctors D ON D.id = RES.IdMED" +

     "LEFT JOIN" +

     "usuarios U ON U.identif = RES.IdPac" +

     "LEFT JOIN" +

    "(SELECT COUNT( * ) AS count, status, MAX(fecha) AS fecha, patient_id FROM message_infrasture WHERE receiver_id = ? AND status = 'new'" +
         "AND DATEDIFF(NOW(), fecha) <= ? GROUP BY status, patient_id) AS MI ON RES.IdPac = MI.patient_id" +

     "LEFT JOIN" +

         "(SELECT COUNT( * ) AS count, status, patient_id FROM message_infrasture WHERE receiver_id = ?" +
        "AND DATEDIFF(NOW(), fecha) <= ? GROUP BY patient_id) AS MI2 ON RES.IdPac = MI2.patient_id";

                connection.query(query_str, [doctor, doctor, days_explore, doctor, days_explore],function(err,rows)
                {
                    connection.release();
                    if(!err) 
                    {
                        this.res.json(rows);
                    }           
                });
            }
            else
            {
                var query_str = $query_str = 'SELECT RES.*, RS.stage, RS.datevisit, D.Name AS DocName, D.Surname AS DocSurname, D.Role AS DocRole, U.Name AS PatName, U.Surname AS PatSurname, MI.count AS NewMesCount, MI.fecha AS NewMesFecha, MI2.count AS MesCount  FROM' +
                    '(' +
                        '(SELECT' + 'DLD.id,DLD.IdMED,DLD.IdMED2,DLD.IdPac,DLD.Fecha,DLD.FechaConfirm,DLD.Type FROM doctorslinkdoctors DLD WHERE DLD.IdMED2 = ?)' +
                            'UNION (SELECT' + 'DLD.id,DLD.IdMED,DLD.IdMED2,DLD.IdPac,DLD.Fecha,DLD.FechaConfirm,DLD.Type FROM doctorslinkdoctors DLD INNER JOIN' +
                                '(SELECT DISTINCT DG_1.IdDoctor FROM doctorsgroups DG_1 INNER JOIN doctorsgroups DG_2 ON DG_2.IdDoctor = ? AND DG_1.IdGroup = DG_2.IdGroup) G' +
                            'ON DLD.IdMED2 = G.IdDoctor)' +
                            'ORDER BY Fecha DESC LIMIT 10' +
                    ') RES' +

                        'LEFT JOIN' +

                    'referral_stage RS ON RS.referral_id = RES.id' +

                        'LEFT JOIN' +

                    'doctors D ON D.id = RES.IdMED' +

                        'LEFT JOIN' +

                    'usuarios U ON U.identif = RES.IdPac' +

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, MAX(fecha) AS fecha, patient_id FROM message_infrasture WHERE receiver_id = ? AND status = "new" AND DATEDIFF(NOW(), fecha) <= ? GROUP BY status,patient_id) AS MI ON RES.IdPac = MI.patient_id'+

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, patient_id FROM message_infrasture WHERE receiver_id = ? AND DATEDIFF(NOW(), fecha) <= ? GROUP BY patient_id) AS MI2 ON RES.IdPac = MI2.patient_id';

                connection.query(query_str, [doctor, doctor, doctor, days_explore, doctor, days_explore],function(err,rows)
                {
                    connection.release();
                    if(!err) 
                    {
                        this.res.json(rows);
                    }           
                });
            }
        } else {
            if(group == 0) {
                var query_str = 'SELECT RES.*, RS.stage, RS.datevisit, D.Name AS DocName, D.Surname AS DocSurname, D.Role AS DocRole, U.Name AS PatName, U.Surname AS PatSurname, MI.count AS NewMesCount, MI.fecha AS NewMesFecha, MI2.count AS MesCount  FROM' +
                    '(' +
                        'SELECT * FROM doctorslinkdoctors WHERE IdMED = ? ORDER BY Fecha DESC LIMIT 10' +
                    ') RES' +

                        'LEFT JOIN' +

                    'referral_stage RS ON RS.referral_id = RES.id' +

                        'LEFT JOIN' +

                    'doctors D ON D.id = RES.IdMED2' +

                        'LEFT JOIN' +

                    'usuarios U ON U.identif = RES.IdPac' +

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, MAX(fecha) AS fecha, patient_id FROM message_infrasture WHERE receiver_id = ? AND status = "new" AND DATEDIFF(NOW(), fecha) <= ? GROUP BY status,patient_id) AS MI ON RES.IdPac = MI.patient_id' +

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, patient_id FROM message_infrasture WHERE receiver_id = ? AND DATEDIFF(NOW(), fecha) <= ? GROUP BY patient_id) AS MI2 ON RES.IdPac = MI2.patient_id';

                connection.query(query_str, [doctor, doctor, days_explore, doctor, days_explore],function(err,rows)
                {
                    connection.release();
                    if(!err) 
                    {
                        this.res.json(rows);
                    }           
                });
            }
            else
            {
                var query_str = $query_str = 'SELECT RES.*, RS.stage, RS.datevisit, D.Name AS DocName, D.Surname AS DocSurname, D.Role AS DocRole, U.Name AS PatName, U.Surname AS PatSurname, MI.count AS NewMesCount, MI.fecha AS NewMesFecha, MI2.count AS MesCount  FROM' +
                    '(' +
                        '(SELECT' + 'DLD.id,DLD.IdMED,DLD.IdMED2,DLD.IdPac,DLD.Fecha,DLD.FechaConfirm,DLD.Type FROM doctorslinkdoctors DLD WHERE DLD.IdMED = ?)' +
                            'UNION (SELECT  DLD.id,DLD.IdMED,DLD.IdMED2,DLD.IdPac,DLD.Fecha,DLD.FechaConfirm,DLD.Type FROM doctorslinkdoctors DLD INNER JOIN' +
                                '(SELECT DISTINCT DG_1.IdDoctor FROM doctorsgroups DG_1 INNER JOIN doctorsgroups DG_2 ON DG_2.IdDoctor = ? AND DG_1.IdGroup = DG_2.IdGroup) G' +
                            'ON DLD.IdMED = G.IdDoctor)' +
                            'ORDER BY Fecha DESC LIMIT 10' +
                    ') RES' +

                        'LEFT JOIN' +

                    'referral_stage RS ON RS.referral_id = RES.id' +

                        'LEFT JOIN' +

                    'doctors D ON D.id = RES.IdMED2' +

                        'LEFT JOIN' +

                    'usuarios U ON U.identif = RES.IdPac' +

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, MAX(fecha) AS fecha, patient_id FROM message_infrasture WHERE receiver_id = ? AND status = "new" AND DATEDIFF(NOW(), fecha) <= ? GROUP BY status,patient_id) AS MI ON RES.IdPac = MI.patient_id' +

                        'LEFT JOIN' +

                    '(SELECT COUNT(*) AS count, status, patient_id FROM message_infrasture WHERE receiver_id = ? AND DATEDIFF(NOW(), fecha) <= ? GROUP BY patient_id) AS MI2 ON RES.IdPac = MI2.patient_id';

                connection.query(query_str, [doctor, doctor, doctor, days_explore, doctor, days_explore],function(err,rows)
                {
                    connection.release();
                    if(!err) 
                    {
                        this.res.json(rows);
                    }           
                });
            }
        }

        connection.on('error', function(err) 
        {      
            this.res.json({"code" : 100, "status" : "Error in connection database"});
            return;     
        });      
  });
    return this.res;
};
module.exports = ReferQuery;